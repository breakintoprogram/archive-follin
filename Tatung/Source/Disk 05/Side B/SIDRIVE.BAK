ORG 60000
LOAD 49152

TOP:LD HL,50000
LD (DATAA+1),HL
LD HL,52000
LD (DATAB+1),HL
LD HL,54000
LD (DATAC+1),HL
LD A,1
LD (CHANA+1),A
LD (CHANB+1),A
LD (CHANC+1),A
XOR A
OUT (254),A
RET
SPLAT:
LD A,2
OUT (254),A

CHANA:LD A,000
DEC A
LD (CHANA+1),A
JP NZ,CHANB
DATAA:LD HL,000
DATR:LD A,(HL)
INC HL
CP 255
JR Z,TOP
CP 1
JR NZ,NEA1
AREM:LD A,000
DEC A
JR Z,DATR
LD (AREM+1),A
LD HL,(ARST)
JP DATR
NEA1:CP 2
JR NZ,NEA2
LD A,(HL)
INC HL
LD (AREM+1),A
LD (ARST),HL
JP DATR
NEA2:CP 3
JR NZ,NEA3
LD BC,65533
LD A,8
OUT (C),A
LD BC,49149
LD A,(HL)
OUT (C),A
LD (AENV+1),A
LD (AVOL),A
LD (A%ENV%),A
INC HL
LD A,(HL)
LD (AENA+1),A
LD (A%ENA%+1),A
INC HL
LD A,(HL)
LD (AEND+1),A
LD (A%END%+1),A
LD (ATAGE+1),A
INC HL
LD A,(HL)
LD (AENS+1),A
INC HL
LD A,(HL)
LD (GATE+1),A
INC HL
JP DATR
NEA3:CP 4
JR NZ,NEA4
XOR A
LD (AEINI+1),A
JP DATR
NEA4:CP 5
JR NZ,NEA5
LD A,1
LD (AEINI+1),A
JP DATR
NEA5:CP 6
JR NZ,NEA6
LD A,(HL)
LD (VIB+1),A
LD (DELAY+1),A
INC HL
JP DATR
NEA6:LD D,A
LD E,(HL)
INC HL
LD A,(HL)
LD (CHANA+1),A
INC HL
LD (DATAA+1),HL
LD BC,65533
XOR A
OUT (C),A
LD BC,49149
LD A,D
LD (APITCH+1),A
OUT (C),A
LD BC,65533
LD A,1
OUT (C),A
LD BC,49149
LD A,E
OUT (C),A
AEINI:LD A,000
DEC A
JR NZ,CHANB
LD A,(A%ENV%)
LD (AVOL),A
LD (AENV+1),A
LD A,(A%END%+1)
LD (ATAGE+1),A
DELAY:LD A,000
LD (VIB+1),A
CHANB:LD A,000
DEC A
LD (CHANB+1),A
JP NZ,CHANC
DATAB:LD HL,000
DBTR:LD A,(HL)
INC HL
CP 255
JP Z,TOP
CP 1
JR NZ,NEB1
BREM:LD A,000
DEC A
JR Z,DBTR
LD (BREM+1),A
LD HL,(BRST)
JP DBTR
NEB1:CP 2
JR NZ,NEB2
LD A,(HL)
INC HL
LD (BREM+1),A
LD (BRST),HL
JP DBTR
NEB2:CP 3
JR NZ,NEB3
LD BC,65533
LD A,9
OUT (C),A
LD BC,49149
LD A,(HL)
OUT (C),A
LD (BENV+1),A
LD (BVOL),A
LD (B%ENV%),A
INC HL
LD A,(HL)
LD (BENA+1),A
LD (B%ENA%+1),A
INC HL
LD A,(HL)
LD (BEND+1),A
LD (B%END%+1),A
INC HL
LD A,(HL)
LD (BENS+1),A
INC HL
JP DBTR
NEB3:CP 4
JR NZ,NEB4
XOR A
LD (BEINI+1),A
JP DBTR
NEB4:CP 5
JR NZ,NEB5
LD A,1
LD (BEINI+1),A
JP DBTR
NEB5:CP 7
JR NZ,NEB6
LD BC,65533
LD A,7
OUT (C),A
LD BC,49149
LD A,(HL)
INC HL
OUT (C),A
LD BC,65533
LD A,6
OUT (C),A
LD BC,49149
LD A,(HL)
INC HL
OUT (C),A
JP DBTR
NEB6:LD D,A
LD E,(HL)
INC HL
LD A,(HL)
LD (CHANB+1),A
INC HL
LD (DATAB+1),HL
LD BC,65533
LD A,2
OUT (C),A
LD BC,49149
LD A,D
OUT (C),A
LD BC,65533
LD A,3
OUT (C),A
LD BC,49149
LD A,E
OUT (C),A
BEINI:LD A,000
DEC A
JR NZ,CHANC
LD A,(B%ENV%)
LD (BVOL),A
LD (BENV+1),A
CHANC:LD A,000
DEC A
LD (CHANC+1),A
JP NZ,AENV
DATAC:LD HL,000
DCTR:LD A,(HL)
INC HL
CP 255
JP Z,TOP
CP 1
JR NZ,NEC1
CREM:LD A,000
DEC A
JR Z,DCTR
LD (CREM+1),A
LD HL,(CRST)
JP DCTR
NEC1:CP 2
JR NZ,NEC2
LD A,(HL)
INC HL
LD (CREM+1),A
LD (CRST),HL
JP DCTR
NEC2:CP 3
JR NZ,NEC3
LD BC,65533
LD A,10
OUT (C),A
LD BC,49149
LD A,(HL)
OUT (C),A
LD (CENV+1),A
LD (CVOL),A
LD (C%ENV%),A
INC HL
LD A,(HL)
LD (CENA+1),A
LD (C%ENA%+1),A
INC HL
LD A,(HL)
LD (CEND+1),A
LD (C%END%+1),A
INC HL
LD A,(HL)
LD (CENS+1),A
INC HL
JP DCTR
NEC3:CP 4
JR NZ,NEC4
XOR A
LD (CEINI+1),A
JP DCTR
NEC4:CP 5
JR NZ,NEC5
LD A,1
LD (CEINI+1),A
JP DCTR
NEC5:LD D,A
LD E,(HL)
INC HL
LD A,(HL)
LD (CHANC+1),A
INC HL
LD (DATAC+1),HL
LD BC,65533
LD A,4
OUT (C),A
LD BC,49149
LD A,D
OUT (C),A
LD BC,65533
LD A,5
OUT (C),A
LD BC,49149
LD A,E
OUT (C),A
CEINI:LD A,000
DEC A
JR NZ,AENV
LD A,(C%ENV%)
LD (CVOL),A
LD (CENV+1),A
AENV:LD A,000
CP 13
JP Z,AEND
AENA:LD A,000
DEC A
LD (AENA+1),A
JR NZ,GATE
A%ENA%:LD A,000
LD (AENA+1),A
LD BC,65533
LD A,8
OUT (C),A
LD BC,49149
LD A,(AVOL)
INC A
LD (AVOL),A
LD (AENV+1),A
OUT (C),A
JP GATE
AEND:LD A,000
DEC A
LD (AEND+1),A
JR NZ,GATE
A%END%:LD A,000
LD (AEND+1),A
ATAGE:LD A,000
LD (AEND+1),A
LD BC,65533
LD A,8
OUT (C),A
LD BC,49149
LD A,(AVOL)
DEC A
OUT (C),A
AENS:CP 000
JP Z,GATE
LD (AVOL),A
GATE:LD A,000
AND A
JR Z,BENV
LD B,A
LD A,(CHANA+1)
CP B
JR NZ,BENV
LD A,13
LD (AENV+1),A
LD A,1
LD (AEND+1),A
LD (ATAGE+1),A
BENV:LD A,000
CP 13
JP Z,BEND
BENA:LD A,000
DEC A
LD (BENA+1),A
JP NZ,CENV
B%ENA%:LD A,000
LD (BENA+1),A
LD BC,65533
LD A,9
OUT (C),A
LD BC,49149
LD A,(BVOL)
INC A
LD (BVOL),A
LD (BENV+1),A
OUT (C),A
JP CENV
BEND:LD A,000
DEC A
LD (BEND+1),A
JP NZ,CENV
B%END%:LD A,000
LD (BEND+1),A
LD BC,65533
LD A,9
OUT (C),A
LD BC,49149
LD A,(BVOL)
DEC A
OUT (C),A
BENS:CP 000
JR Z,CENV
LD (BVOL),A
CENV:LD A,000
CP 13
JP Z,CEND
CENA:LD A,000
DEC A
LD (CENA+1),A
JP NZ,VIB
C%ENA%:LD A,000
LD (CENA+1),A
LD BC,65533
LD A,10
OUT (C),A
LD BC,49149
LD A,(CVOL)
INC A
OUT (C),A
LD (CVOL),A
LD (CENV+1),A
JP VIB
CEND:LD A,000
DEC A
LD (CEND+1),A
JP NZ,VIB
C%END%:LD A,000
LD (CEND+1),A
LD BC,65533
LD A,10
OUT (C),A
LD BC,49149
LD A,(CVOL)
DEC A
OUT (C),A
CENS:CP 000
JR Z,VIB
LD (CVOL),A
VIB:LD A,000
DEC A
LD (VIB+1),A
JR NZ,CHEN
INC A
LD (VIB+1),A
LD HL,TABLE
BIV1:LD A,000
INC A
AND 7
LD (BIV1+1),A
LD E,A
LD D,0
ADD HL,DE
LD A,(HL)
APITCH:ADD 000
LD D,A
LD BC,65533
XOR A
OUT (C),A
LD BC,49149
LD A,D
OUT (C),A
CHEN:XOR A
OUT (254),A
RET

TABLE:DB 2,1,0-1,0-2,0-2,0-1,1,2

AVOL:DB 0
BVOL:DB 0
CVOL:DB 0

ARST:DW 0
BRST:DW 0
CRST:DW 0

A%ENV%:DB 0
B%ENV%:DB 0
C%ENV%:DB 0

END
